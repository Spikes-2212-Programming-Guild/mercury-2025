<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mercury 2025</title>
</head>
<body>

<div id="top_absolute_navigation"></div>

<div id="questions"></div>

<button id="submit_button" style="display: none" onclick="submit()">Submit</button>

<div id="relative_navigation">
    <button id="prev_button">Previous</button>
    <button id="next_button">Next</button>
</div>

<div id="bottom_absolute_navigation"></div>
</body>

<script>
    class Question {
        constructor(id, title, page) {
            this.id = id
            this.title = title
            this.page = page
            this.element = null
        }

        setValue(newValue) {
            this.element.value = newValue;
        }

        get getValue() {
            return this.element.value;
        }

        setOutlineColor (color) {
            this.element.style.outlineColor = color;
        }

        get getPage() {
            return this.page;
        }

        isValid() {
            return this.getValue !== null && this.getValue !== '' && this.getValue !== undefined;
        }

        clear () {
            this.setValue('');
            this.setOutlineColor('black');
        }

        getElement() {
            const container = document.createElement('div');
            const label = document.createElement('label');
            label.innerHTML = this.title + ' ';
            container.appendChild(label);
            return container;
        }

        addListeners () {
            this.element.addEventListener('input', () => {
                this.element.value = this.getValue;
                localStorage.setItem(this.id, this.getValue);
                this.setOutlineColor(this.isValid() ? 'green' : 'red');
            })
        }
    }

    class TextQuestion extends Question {
        static type = 'text';

        getElement() {
            const container = super.getElement();
            const input = document.createElement('input');
            input.type = 'text';
            input.style.outline = '2px solid black';
            container.appendChild(input);
            this.element = input;
            this.addListeners()

            return container;
        }
    }

    class MultipleChoiceQuestion extends Question {
        static type = 'choices';

        constructor(id, title, page, choices) {
            super(id, title, page);
            this.choices = choices;
        }

        getElement() {
            const container = super.getElement();
            const select = document.createElement('select');
            select.style.outline = '2px solid black';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Choose';
            select.appendChild(defaultOption);

            this.choices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                select.appendChild(option);
            });

            container.appendChild(select);
            this.element = select
            this.addListeners()
            return container;
        }
    }

    class NumberQuestion extends Question {
        static type = 'number';

        getElement() {
            const container = super.getElement();
            const input = document.createElement('input');
            input.type = 'number';
            input.style.outline = '2px solid black';
            container.appendChild(input);
            this.element = input;
            this.addListeners()
            return container;
        }
    }

    const json = {
        "Pages": [
            {
                "name": "Pre-Game",
                "questions": [
                    {"id": "scouter_name", "title": "Enter scouter name", "type": TextQuestion.type},
                    {
                        "id": "alliance",
                        "title": "Enter the alliance",
                        "choices": ["blue", "red"],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
            {
                "name": "Autonomous",
                "questions": [
                    {
                        "id": "robot_state",
                        "title": "Choose the robot's state",
                        "choices": ["Alright", "Stunned", "Kaboom!"],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
        ]
    };

    async function submit() {
        const formData = {};
        for (const question of questionObjects) {
            if (!question.isValid()) {
                alert('Invalid value at ' + question.id.replace('_', ' '));
                displayPage(question.getPage.name)
                return;
            }
            formData[question.id] = question.getValue;
        }
        try {
            const response = await fetch("http://localhost:3000/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });
            if (response.ok) {
                saveAnswers(true)
                displayPage(pagesConfig[0].name);
            }
        } catch (error) {
            saveAnswers(false)
        }
        clearAllAnswers()
    }

    function saveAnswers(saved) {
        const formAnswers = {};
        for (const question of questionObjects) {
            formAnswers[question.id] = question.getValue; // ✅ This part is fine
        }
        console.log("Answers to Save:", formAnswers);
        const allSubmissions = JSON.parse(localStorage.getItem('allSubmissions')) || [];
        allSubmissions.push(formAnswers);
        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

        if (!saved) {
            let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || [];
            console.log("Before Saving - Unsent:", unsentSubmissions);

            unsentSubmissions.push(formAnswers);
            localStorage.setItem('unsentSubmissions', JSON.stringify(unsentSubmissions));
            console.log("After Saving - Unsent:", JSON.parse(localStorage.getItem('unsentSubmissions')));
        }
        alert(saved ? 'Saved successfully' : 'Saved Failed');
        sendAllUnSavedAnswers()
    }

    async function sendAllUnSavedAnswers() {
        let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || []
        let newUnsentSubmissions = []; // Store only failed ones
        for (const submission of unsentSubmissions) {
            try {
                const response = await fetch("http://localhost:3000/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(submission),
                });
                if (response.ok) console.log('Successfully submitted ' + submission);
            } catch (error) {
                console.error("Submission failed:", error);
                newUnsentSubmissions.push(submission); // Keep failed submissions
            }
        }
        // ✅ Only keep failed submissions
        localStorage.setItem('unsentSubmissions', JSON.stringify(newUnsentSubmissions));
    }

    function clearAllAnswers() {
        Object.keys(localStorage).forEach(key => {
            localStorage.removeItem(key);
        });
        for (const question of questionObjects) {
            question.clear();
        }
    }

    function renderAbsoluteNavigationButtons(container) {
        pagesConfig.forEach(page => {
            const button = document.createElement('button');
            button.innerHTML = page.name;
            button.addEventListener('click', () => displayPage(page.name));
            container.appendChild(button);
        });
    }

    function displayPage(pageName) {
        for (const page of document.getElementsByClassName('page')) {
            page.style.display = page.id === pageName ? 'block' : 'none';
        }
        currentPageConfig = pagesConfig.find(page => page.name === pageName);
        updateButtons();
    }

    function updateButtons() {
        const pageIndex = pagesConfig.indexOf(currentPageConfig);
        const nextButton = config.relativeNavigationButtons.next;
        const prevButton = config.relativeNavigationButtons.prev;
        const submitButton = config.submitButton;

        submitButton.style.display = pageIndex === pagesConfig.length - 1 ? 'block' : 'none';

        prevButton.style.visibility = pageIndex > 0 ? 'visible' : 'hidden';
        prevButton.onclick = pageIndex > 0 ? () => displayPage(pagesConfig[pageIndex - 1].name) : null;

        nextButton.style.visibility = pageIndex + 1 < pagesConfig.length ? 'visible' : 'hidden';
        nextButton.onclick = pageIndex + 1 < pagesConfig.length ? () => displayPage(pagesConfig[pageIndex + 1].name) : null;
    }

    function createAllQuestions() {
        pagesConfig.forEach(page => {
            const pageContainer = document.createElement('fieldset');
            pageContainer.classList.add('page');
            pageContainer.id = page.name;

            page.questions.forEach(question => {
                const questionObject = createQuestion(question, page);
                pageContainer.appendChild(questionObject.getElement());
                questionObjects.push(questionObject); // Add to the page's question list
            });
            config.questionContainer.appendChild(pageContainer);
        });
    }

    function createQuestion(question, page) {
        switch (question.type) {
            case TextQuestion.type:
                return new TextQuestion(question.id, question.title, page);
            case NumberQuestion.type:
                return new NumberQuestion(question.id, question.title, page);
            case MultipleChoiceQuestion.type:
                return new MultipleChoiceQuestion(question.id, question.title, page, question.choices);
        }
    }

    function initializeApp(config) {
        createAllQuestions();
        renderAbsoluteNavigationButtons(config.absoluteNavContainers.top);
        renderAbsoluteNavigationButtons(config.absoluteNavContainers.bottom);
        displayPage(pagesConfig[0].name);
    }

    // global variables
    const config = {
        questionContainer: document.getElementById('questions'),
        submitButton: document.getElementById('submit_button'),
        absoluteNavContainers: {
            top: document.getElementById('top_absolute_navigation'),
            bottom: document.getElementById('bottom_absolute_navigation')
        },
        relativeNavigationButtons: {
            prev: document.getElementById('prev_button'),
            next: document.getElementById('next_button'),
        }
    };

    const pagesConfig = json.Pages;
    const questionObjects = [];
    let currentPageConfig = pagesConfig[0];

    initializeApp(config);

    // try to save all unsaved answers every 4 minutes
    setInterval(() => {
        try {
            sendAllUnSavedAnswers();
        } catch (error) {
            console.error("Error in sendAllUnSavedAnswers:", error);
        }
    }, 4*60*1000);

</script>
</html>