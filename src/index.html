<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mercury 2025</title>
</head>
<body>

<div id="top_absolute_navigation"></div>

<div id="questions"></div>

<button id="submit_button" style="display: none" onclick="submit()">Submit</button>

<div id="relative_navigation">
    <button id="prev_button">Previous</button>
    <button id="next_button">Next</button>
</div>

<div id="bottom_absolute_navigation"></div>
</body>

<script>
    class Question {
        constructor(id, title, page) {
            this.id = id
            this.title = title
            this.page = page
            this.element = null
        }

        setValue(newValue) {
            this.element.value = newValue;
        }

        get getValue() {
            return this.element.value;
        }

        get getElement() {
            return this.element;
        }

        get getPage() {
            return this.page;
        }

        isValid() {
            return !!this.getValue;
        }

        buildAndGetContainer() {
            const container = document.createElement('div');
            const label = document.createElement('label');
            label.innerHTML = this.title;
            container.appendChild(label);
            return container;
        }
    }

    class TextQuestion extends Question {
        static type = 'text';

        buildAndGetContainer() {
            const container = super.buildAndGetContainer();
            const input = document.createElement('input');
            input.type = 'text';
            input.style.outline = '2px solid black';
            input.addEventListener('input', () => this.value = input.value);
            container.appendChild(input);
            this.element = input;
            return container;
        }
    }

    class MultipleChoiceQuestion extends Question {
        static type = 'choices';

        constructor(id, title, page, choices) {
            super(id, title, page);
            this.choices = choices;
        }

        buildAndGetContainer() {
            const container = super.buildAndGetContainer();
            const select = document.createElement('select');
            select.style.outline = '2px solid black';
            select.addEventListener('change', () => this.value = select.value);

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Choose';
            select.appendChild(defaultOption);

            this.choices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                select.appendChild(option);
            });

            container.appendChild(select);
            this.element = select
            return container;
        }
    }

    class NumberQuestion extends Question {
        static type = 'number';

        buildAndGetContainer() {
            const container = super.buildAndGetContainer();
            const input = document.createElement('input');
            input.type = 'number';
            input.style.outline = '2px solid black';
            input.addEventListener('input', () => this.value = input.value);
            container.appendChild(input);
            this.element = input;
            return container;
        }
    }

    const json = {
        "Pages": [
            {
                "name": "Pre-Game",
                "questions": [
                    {"id": "scouter_name", "title": "Enter scouter name", "type": TextQuestion.type},
                    {
                        "id": "alliance",
                        "title": "Enter the alliance",
                        "choices": ["blue", "red"],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
            {
                "name": "Autonomous",
                "questions": [
                    {
                        "id": "team_number",
                        "title": "Enter team number",
                        "choices": [2212, 1690, 5554],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
            {
                "name": "End-Game",
                "questions": [
                    {"id": "score", "title": "Enter score", "type": NumberQuestion.type}
                ]
            }
        ]
    };

    async function submit() {
        const formData = {};
        for (const question of questionObjects) {
            if (!question.isValid()) {
                alert('Invalid value at ' + question.id.replace('_', ' '));
                displayPage(question.getPage.name)
                return;
            }
            formData[question.id] = question.getValue;
        }
        try {
            const response = await fetch("http://localhost:3000/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });
            if (response.ok) {
                alert("Form data inserted successfully");

                Object.keys(localStorage).forEach(key => {
                    localStorage.removeItem(key);
                });

                clearAllAnswers();

                displayPage(pagesConfig[0].name);

            } else {
                alert("Error inserting form data");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error inserting form data");
        }
    }

    function clearAllAnswers() {
        for (const question of questionObjects) {
            question.setValue(null);
        }
    }

    function renderAbsoluteNavigationButtons(container) {
        pagesConfig.forEach(page => {
            const button = document.createElement('button');
            button.innerHTML = page.name;
            button.addEventListener('click', () => displayPage(page.name));
            container.appendChild(button);
        });
    }

    function displayPage(pageName) {
        for (const page of document.getElementsByClassName('page')) {
            page.style.display = page.id === pageName ? 'block' : 'none';
        }
        currentPageConfig = pagesConfig.find(page => page.name === pageName);
        updateButtons();
    }

    function updateButtons() {
        const pageIndex = pagesConfig.indexOf(currentPageConfig);
        const nextButton = config.relativeNavigationButtons.next;
        const prevButton = config.relativeNavigationButtons.prev;
        const submitButton = config.submitButton;

        submitButton.style.display = pageIndex === pagesConfig.length - 1 ? 'block' : 'none';

        prevButton.style.visibility = pageIndex > 0 ? 'visible' : 'hidden';
        prevButton.onclick = pageIndex > 0 ? () => displayPage(pagesConfig[pageIndex - 1].name) : null;

        nextButton.style.visibility = pageIndex + 1 < pagesConfig.length ? 'visible' : 'hidden';
        nextButton.onclick = pageIndex + 1 < pagesConfig.length ? () => displayPage(pagesConfig[pageIndex + 1].name) : null;
    }

    function createAllQuestions() {
        pagesConfig.forEach(page => {
            const pageContainer = document.createElement('fieldset');
            pageContainer.classList.add('page');
            pageContainer.id = page.name;

            page.questions.forEach(question => {
                const questionObject = createQuestion(question, page);
                pageContainer.appendChild(questionObject.buildAndGetContainer());
                questionObjects.push(questionObject); // Add to the page's question list
            });
            config.questionContainer.appendChild(pageContainer);
        });
    }

    function createQuestion(question, page) {
        switch (question.type) {
            case TextQuestion.type:
                return new TextQuestion(question.id, question.title, page);
            case NumberQuestion.type:
                return new NumberQuestion(question.id, question.title, page);
            case MultipleChoiceQuestion.type:
                return new MultipleChoiceQuestion(question.id, question.title, page, question.choices);
        }
    }

    function setupSaving() {
        for (const question of questionObjects) {
            question.getElement.addEventListener('change', () => {
                localStorage.setItem(question.id, question.getValue);
                question.getElement.style.outlineColor = question.isValid() ? 'green' : 'red';
            });
        }
    }

    function initializeApp(config) {
        createAllQuestions();
        renderAbsoluteNavigationButtons(config.absoluteNavContainers.top);
        renderAbsoluteNavigationButtons(config.absoluteNavContainers.bottom);
        displayPage(pagesConfig[0].name);
        setupSaving();
    }

    // global variables
    const config = {
        questionContainer: document.getElementById('questions'),
        submitButton: document.getElementById('submit_button'),
        absoluteNavContainers: {
            top: document.getElementById('top_absolute_navigation'),
            bottom: document.getElementById('bottom_absolute_navigation')
        },
        relativeNavigationButtons: {
            prev: document.getElementById('prev_button'),
            next: document.getElementById('next_button'),
        }
    };

    const pagesConfig = json.Pages;
    const questionObjects = [];
    let currentPageConfig = pagesConfig[0];

    initializeApp(config);

</script>
</html>