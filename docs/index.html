<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mercury 2025</title>
</head>
<body>

<div id="absolute_navigation_container"></div>

<h1 id="title">Mercury 2025</h1>

<div id="pages_container"></div>

<div id="relative_navigation_container">
    <button id="prev_button" class="relative_navigation">< Previous</button>
    <button id="submit_button" onclick="submit()">Submit</button>
    <button id="next_button" class="relative_navigation">Next></button>
</div>

</body>

<style>
    /* Global styles */
    * {
        background-color: #282c34;
        color: white;
        font-size: 1.25em;
        border: none;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
    }

    /* Centering the main content */
    .page {
        display: flex;
        justify-content: center;
        align-content: center;
        flex-direction: column;
        gap: 1em;
        height: 65vh;
    }

    #pages_container {
        margin-bottom: 30vh;
    }

    /* Form styling */
    .question {
        margin: 1%;
    }

    .question input, .question select {
        outline: white 3px solid;
        border-radius: 10px;
    }

    .question label {
        margin-right: 2%;
        /*font-weight: bold;*/
    }

    /* Navigation bars */
    .absolute_navigation {
        padding: 1%;
        width: 33.33vw;
        background-color: #0056b3;
        height: 8.5vh;
    }

    #absolute_navigation_container {
        position: fixed;
        top: 0;
        left: 50%;
        flex-direction: row;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .relative_navigation {
        width: 30vw;
        height: 6.5vh;
        margin: 2.5%;
        border-radius: 20px;
    }

    #relative_navigation_container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
    }

    /* Buttons */
    #submit_button {
        background-color: #0056b3;
        border-radius: 75px;
        padding: 2vw;
        margin: 3vw;
        width: 25vw;
    }

    /* Title */
    #title {
        margin-top: 26vw;
        font-size: 2.55em;
    }

    /* Hover Effects */
    .absolute_navigation:hover,
    #submit_button:hover {
        background-color: #034790;
    }

    .relative_navigation:hover {
        background-color: #5a6268;
    }

    .relative_navigation:disabled {
        background-color: #5a6268;
        cursor: not-allowed;
    }

</style>

<script>
    class Question {
        constructor(id, title, page) {
            this.id = id
            this.title = title
            this.page = page
            this.element = null
        }

        setValue(newValue) {
            this.element.value = newValue;
        }

        get getValue() {
            return this.element.value;
        }

        setOutlineColor (color) {
            this.element.style.outlineColor = color;
        }

        get getPage() {
            return this.page;
        }

        isValid() {
            return this.getValue !== null && this.getValue !== '' && this.getValue !== undefined;
        }

        clear () {
            this.setValue('');
            this.setOutlineColor('white');
        }

        getElement() {
            const container = document.createElement('fieldset');
            container.classList.add("question");
            const label = document.createElement('label');
            label.innerHTML = this.title;
            container.appendChild(label);
            return container;
        }

        addListeners () {
            this.element.addEventListener('input', () => {
                localStorage.setItem(this.id, this.getValue);
                this.setOutlineColor(this.isValid() ? 'green' : 'red');
            })
        }
    }

    class TextQuestion extends Question {
        static type = 'text';

        getElement() {
            const container = super.getElement();
            const input = document.createElement('input');
            input.type = 'text';
            container.appendChild(input);
            this.element = input;
            this.addListeners()
            return container;
        }
    }

    class MultipleChoiceQuestion extends Question {
        static type = 'choices';

        constructor(id, title, page, choices) {
            super(id, title, page);
            this.choices = choices;
        }

        getElement() {
            const container = super.getElement();
            const select = document.createElement('select');

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Choose';
            select.appendChild(defaultOption);

            this.choices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                select.appendChild(option);
            });

            container.appendChild(select);
            this.element = select
            this.addListeners()
            return container;
        }
    }

    class NumberQuestion extends Question {
        static type = 'number';

        getElement() {
            const container = super.getElement();
            const input = document.createElement('input');
            input.type = 'number';
            container.appendChild(input);
            this.element = input;
            this.addListeners()
            return container;
        }
    }

    async function submit() {
        const formData = {};
        for (const question of questionObjects) {
            if (!question.isValid()) {
                alert('Invalid value at ' + question.id.replace('_', ' '));
                displayPage(question.getPage.name)
                return;
            }
            formData[question.id] = question.getValue;
        }
        try {
            const response = await fetch("http://localhost:3000/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });
            if (response.ok) {
                saveAnswers(true, formData)
                displayPage(pagesConfig[0].name);
            }
        } catch (error) {
            saveAnswers(false, formData)
        }
        clearAllAnswers()
    }

    function saveAnswers(saved, formAnswers) {
        console.log("Answers to Save:", formAnswers);

        const allSubmissions = JSON.parse(localStorage.getItem('allSubmissions')) || [];
        allSubmissions.push(formAnswers);
        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

        if (!saved) {
            let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || [];
            console.log("Before Saving - Unsent:", unsentSubmissions);

            unsentSubmissions.push(formAnswers);
            localStorage.setItem('unsentSubmissions', JSON.stringify(unsentSubmissions));
            console.log("After Saving - Unsent:", JSON.parse(localStorage.getItem('unsentSubmissions')));
        }
        alert(saved ? 'Saved successfully' : 'Saved Failed');
        sendAllUnSavedAnswers()
    }

    async function sendAllUnSavedAnswers() {
        let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || []
        let newUnsentSubmissions = []; // Store only failed ones
        for (const submission of unsentSubmissions) {
            try {
                const response = await fetch("http://localhost:3000/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(submission),
                });
                if (response.ok) console.log('Successfully submitted ' + submission);
            } catch (error) {
                console.error("Submission failed:", error);
                newUnsentSubmissions.push(submission);
            }
        }
        // âœ… Only keep failed submissions
        localStorage.setItem('unsentSubmissions', JSON.stringify(newUnsentSubmissions));
    }

    function clearAllAnswers() {
        Object.keys(localStorage).forEach(key => {
            localStorage.removeItem(key);
        });
        for (const question of questionObjects) {
            question.clear();
        }
    }

    function renderAbsoluteNavigationButtons(container) {
        pagesConfig.forEach(page => {
            const button = document.createElement('button');
            button.innerHTML = page.name;
            button.classList.add('absolute_navigation');
            button.addEventListener('click', () => displayPage(page.name));
            container.appendChild(button);
            absoluteNavigationElements.push(button)
        });
    }

    function displayPage(pageName) {
        for (const page of document.getElementsByClassName('page')) {
            page.style.display = page.id === pageName ? 'block' : 'none';
        }
        updateButtons(pageName);
        config.titleLabel.innerHTML = pageName;
    }

    function updateButtons(pageName) {
        let currentPageConfig = pagesConfig.find(page => page.name === pageName);
        const pageIndex = pagesConfig.indexOf(currentPageConfig);
        const nextButton = config.relativeNavigationButtons.next;
        const prevButton = config.relativeNavigationButtons.prev;

        prevButton.style.disabeled = pageIndex > 0 ? 'true' : 'false';
        prevButton.style.color = pageIndex > 0 ? 'white' : 'gray';
        prevButton.onclick = pageIndex > 0 ? () => displayPage(pagesConfig[pageIndex - 1].name) : null;

        nextButton.style.color = pageIndex + 1 < pagesConfig.length ? 'white' : 'gray';
        nextButton.style.disabeled = pageIndex + 1 < pagesConfig.length ? 'true' : 'false';
        nextButton.onclick = pageIndex + 1 < pagesConfig.length ? () => displayPage(pagesConfig[pageIndex + 1].name) : null;

        console.log("e")
        for (const pageButton of absoluteNavigationElements) {
            pageButton.style.fontWeight = pageButton.innerHTML === pageName ? 'bold' : 'normal'
        }
    }

    function createAllQuestions() {
        pagesConfig.forEach(page => {
            const pageContainer = document.createElement('fieldset');
            pageContainer.classList.add('page');
            pageContainer.id = page.name;

            page.questions.forEach(question => {
                const questionObject = createQuestion(question, page);
                pageContainer.appendChild(questionObject.getElement());
                questionObjects.push(questionObject); // Add to the page's question list
            });
            config.pagesContainer.appendChild(pageContainer);
        });
    }

    function createQuestion(question, page) {
        switch (question.type) {
            case TextQuestion.type:
                return new TextQuestion(question.id, question.title, page);
            case NumberQuestion.type:
                return new NumberQuestion(question.id, question.title, page);
            case MultipleChoiceQuestion.type:
                return new MultipleChoiceQuestion(question.id, question.title, page, question.choices);
        }
    }

    function initializeApp(config) {
        createAllQuestions();
        renderAbsoluteNavigationButtons(config.absoluteNavContainer);
        displayPage(pagesConfig[0].name);
    }

    const json = {
        "Pages": [
            {
                "name": "Pre-Game",
                "questions": [
                    {"id": "scouter_name", "title": "Enter scouter name", "type": TextQuestion.type},
                    {"id": "robot_name", "title": "Enter robot name", "type": TextQuestion.type},
                    {"id": "robot_name1", "title": "Enter robot name", "type": TextQuestion.type},
                    {"id": "robot_number", "title": "Enter robot number", "type": NumberQuestion.type},
                    {"id": "robot_name3", "title": "Enter robot name", "type": TextQuestion.type},
                    {"id": "robot_name4", "title": "Enter robot name", "type": TextQuestion.type},
                    {"id": "robot_name5", "title": "Enter robot name", "type": TextQuestion.type},
                ]
            },
            {
                "name": "Autonomous",
                "questions": [
                    {"id": "robot_state", "title": "Choose the robot's state", "choices": ["Alright", "Stunned", "Kaboom!"],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
            {
                "name": "End-Game",
                "questions": [
                    {"id": "alliance", "title": "Enter the alliance", "choices": ["blue", "red"],
                        "type": MultipleChoiceQuestion.type
                    }
                ]
            },
        ]
    };

    // global variables
    const config = {
        pagesContainer: document.getElementById('pages_container'),
        titleLabel: document.getElementById('title'),
        absoluteNavContainer: document.getElementById('absolute_navigation_container'),
        relativeNavigationButtons: {
            prev: document.getElementById('prev_button'),
            next: document.getElementById('next_button'),
        }
    };

    const pagesConfig = json.Pages;
    const questionObjects = [];
    const absoluteNavigationElements = []

    initializeApp(config);

    // try to save all unsaved answers every 4 minutes
    setInterval(() => {
        try { sendAllUnSavedAnswers();
        } catch (error) {
            console.error("Error in sendAllUnSavedAnswers:", error);
        }
    }, 4*60*1000);

</script>
</html>