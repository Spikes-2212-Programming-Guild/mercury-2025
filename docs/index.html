<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no">
    <title>Mercury 2025</title>
</head>
<body>

<div id="absolute_navigation_container"></div>

<h1 id="title">Mercury 2025</h1>

<div id="pages_container"></div>

<div id="loadingOverlay">Submitting...</div>

<div id="relative_navigation_container">
    <button id="prev_button" class="relative_navigation">< Previous</button>
    <button id="submit_button" onclick="submit()">Submit</button>
    <button id="next_button" class="relative_navigation">Next></button>
</div>

</body>

<style>
    /* ========== GLOBAL STYLES ========== */
    * {
        background-color: #282c34;
        color: white;
        font-size: 1.25em;
        border: none;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }

    /* ========== LAYOUT ========== */
    #title {
        margin-top: 26vw;
        font-size: 2.55em;
    }

    #pages_container {
        margin-bottom: 40vh;
    }

    .page {
        display: flex;
        align-content: start;
        flex-direction: column;
        gap: 1em;
        height: 140vh;
    }

    /* ========== NAVIGATION ========== */
    #absolute_navigation_container {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    #relative_navigation_container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
    }

    #loadingOverlay {
        visibility: hidden;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 2em;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    /* ========== BUTTONS ========== */
    button {
        cursor: pointer;
    }

    .absolute_navigation {
        padding: 1%;
        width: 20vw;
        background-color: #0056b3;
        height: 8.5vh;
    }

    .relative_navigation {
        width: 30vw;
        height: 6.5vh;
        margin: 2.5%;
        border-radius: 20px;
    }

    #submit_button {
        background-color: #0056b3;
        border-radius: 75px;
        padding: 2vw;
        margin: 3vw;
        width: 25vw;
    }

    /* ========== FORM ELEMENTS ========== */
    .question {
        margin: 1em;
        align-content: center;
    }

    .question input,
    .question select {
        outline: white 3px solid;
        margin: 0.3em;
        width: 7em;
        border-radius: 10px;
    }

    /* ========== HOVER EFFECTS ========== */
    .absolute_navigation:hover,
    #submit_button:hover {
        background-color: #034790;
    }

    .relative_navigation:hover {
        background-color: #5a6268;
    }

    .relative_navigation:disabled {
        background-color: #5a6268;
        cursor: not-allowed;
    }
</style>

<script>
    class Question {
        constructor(id, title, separateLine, page) {
            this.id = id;
            this.title = title;
            this.page = page;
            this.element = null;
            this.separateLine = separateLine;
        }

        setValue(newValue) {
            this.element.value = newValue;
        }

        get getValue() {
            return this.element.value;
        }

        get getBoundingRect() {
            return this.element.getBoundingClientRect();
        }

        setOutlineColor(color) {
            this.element.style.outlineColor = color;
        }

        get getPage() {
            return this.page;
        }

        isValid() {
            return this.getValue !== null && this.getValue !== '' && this.getValue !== undefined;
        }

        clear() {
            this.setValue('');
            this.setOutlineColor('white');
        }

        getElement() {
            const container = document.createElement('fieldset');
            container.id = this.id;
            container.classList.add("question");
            const label = document.createElement('label');
            label.innerHTML = this.title;
            container.appendChild(label);

            if (this.separateLine) container.appendChild(document.createElement('br'));
            else label.style.marginRight = '5%';

            return container;
        }

        updateColor() {
            this.setOutlineColor(this.isValid() ? 'green' : 'red');
        }

        addListeners() {
            this.element.addEventListener('input', () => {
                localStorage.setItem(this.id, this.getValue);
                this.updateColor()
            })
        }
    }

    class TextQuestion extends Question {
        static type = 'text';

        isValid() {
            return super.isValid() && this.getValue.length > 0 && this.getValue.length < 200;
        }

        getElement() {
            const container = super.getElement();
            const input = document.createElement('input');
            input.type = 'text';
            container.appendChild(input);
            this.element = input;
            this.addListeners()
            return container;
        }
    }

    class MultipleChoiceQuestion extends Question {
        static type = 'choices';

        constructor(id, title, separateLine, page, choices) {
            super(id, title, separateLine, page);
            this.choices = choices;
        }

        getElement() {
            const container = super.getElement();
            const select = document.createElement('select');

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Choose';
            select.appendChild(defaultOption);

            this.choices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                select.appendChild(option);
            });

            container.appendChild(select);
            this.element = select
            this.addListeners()
            return container;
        }
    }

    class NumberFromChoicesQuestion extends Question {
        static type = 'numberFromChoices';

        constructor(id, title, separateLine, page, choices) {
            super(id, title, separateLine, page);
            this.choices = choices;
        }

        isValid() {
            return super.isValid() && this.choices.includes(parseInt(this.getValue));
        }

        getElement() {
            const container = super.getElement();

            // Create input field
            const input = document.createElement('input');
            input.type = 'number';
            input.setAttribute('list', this.id + '_input');

            // Create datalist
            const datalist = document.createElement('datalist');
            datalist.id = this.id + '_input';

            this.choices.forEach(choice => {
                const option = document.createElement('option');
                option.value = choice;
                option.textContent = choice;
                datalist.appendChild(option);
            });

            container.appendChild(input);
            container.appendChild(datalist);
            this.element = input;
            this.addListeners()
            return container;
        }
    }

    class NumberQuestion extends Question {
        static type = 'number';

        isValid() {
            return super.isValid() && this.getValue <= 32767 && this.getValue >= 0;
        }

        clear() {
            this.setValue(-1);
            this.setOutlineColor('white');
        }

        getElement() {
            const container = super.getElement();

            const decrementButton = document.createElement('button');
            decrementButton.textContent = '-';
            decrementButton.style.marginRight = "40px";
            decrementButton.style.fontSize = "2em";
            decrementButton.onclick = () => {
                if (this.element.value > 0) {
                    this.element.stepDown(); // dec the number
                    this.element.dispatchEvent(new Event('input'));
                }
            };

            const input = document.createElement('input');
            input.type = 'number';
            input.value = -1;
            input.style.width = "2em";
            this.element = input;

            const incrementButton = document.createElement('button');
            incrementButton.textContent = "+";
            incrementButton.style.fontSize = "2em";
            incrementButton.style.marginLeft = "40px";
            incrementButton.onclick = () => {
                this.element.stepUp(); // inc the number
                this.element.dispatchEvent(new Event('input')); // Trigger change event
            };

            container.appendChild(decrementButton);
            container.appendChild(input);
            container.appendChild(incrementButton);

            this.addListeners();
            return container;
        }
    }

    async function submit() {
        const formData = {};

        for (const question of questionObjects) {
            question.updateColor();
            if (!question.isValid()) {
                // Mark the invalid question
                question.setOutlineColor("yellow");

                // Move it to its page
                displayPage(question.getPage.name);

                // Move the user to its position
                const rect = question.getBoundingRect;
                const absoluteY = window.scrollY + rect.top - window.innerHeight / 2 + rect.height / 2;
                window.scrollTo({ top: absoluteY, behavior: "smooth" });

                // Re-enable UI before returning
                document.body.style.pointerEvents = "auto";
                return;
            }
            formData[question.id] = question.getValue;
        }

        // Disable all interactive elements
        document.body.style.pointerEvents = "none";
        document.getElementById("loadingOverlay").style.visibility = "visible";

        try {
            const response = await fetch("https://mercury-2025-server.onrender.com/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });

            if (response.ok) {
                saveAnswers(true, formData);
                displayPage(pagesConfig[0].name);
            }
        } catch (error) {
            if (error instanceof TypeError) {
                console.error("Submission failed due to wifi " + error);
                saveAnswers(false, formData);
            } else {
                console.error("Bugged submission, not saving");
            }
        }

        // Clear answers and re-enable UI
        clearAllAnswers();
        document.body.style.pointerEvents = "auto";
        document.getElementById("loadingOverlay").style.visibility = "hidden";
    }

    function saveAnswers(saved, formAnswers) {
        console.log("Answers to Save:", formAnswers);

        let allSubmissions = JSON.parse(localStorage.getItem('allSubmissions')) || [];
        allSubmissions.push(formAnswers);
        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

        if (!saved) {
            let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || [];
            console.log("Before Saving - Unsent:", unsentSubmissions);

            if (formAnswers !== {}) unsentSubmissions.push(formAnswers);
            localStorage.setItem('unsentSubmissions', JSON.stringify(unsentSubmissions));
            console.log("After Saving - Unsent:", JSON.parse(localStorage.getItem('unsentSubmissions')));
        }
        alert('Saved successfully')
        sendAllUnSavedAnswers()
    }

    async function sendAllUnSavedAnswers() {
        let unsentSubmissions = JSON.parse(localStorage.getItem('unsentSubmissions')) || []
        let newUnsentSubmissions = []; // Store only failed ones
        for (const submission of unsentSubmissions) {
            try {
                const response = await fetch("https://mercury-2025-server.onrender.com/submit", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(submission),
                });
                if (response.ok) console.log('Successfully submitted ' + submission);
            } catch (error) {
                if (error instanceof TypeError) {
                    console.error("Submission failed" + error);
                    newUnsentSubmissions.push(submission);
                } else {
                    console.error("removing bugged submission");
                }
            }
        }
        // Only keep failed submissions
        localStorage.setItem('unsentSubmissions', JSON.stringify(newUnsentSubmissions));
    }

    function clearAllAnswers() {
        for (const question of questionObjects) {
            localStorage.removeItem(question.id);
            question.clear();
        }
    }

    function renderAbsoluteNavigationButtons(container) {
        pagesConfig.forEach(page => {
            const button = document.createElement('button');
            button.innerHTML = page.name;
            button.classList.add('absolute_navigation');
            button.addEventListener('click', () => displayPage(page.name));
            container.appendChild(button);
            absoluteNavigationElements.push(button)
        });
    }

    function displayPage(pageName) {
        for (const page of document.getElementsByClassName('page')) {
            page.style.display = page.id === pageName ? 'block' : 'none';
        }
        window.scrollTo({ top: 0});
        updateButtons(pageName);
        htmlGlobals.titleLabel.innerHTML = pageName;
        localStorage.setItem('currentPage', pageName);
    }

    function updateButtons(pageName) {
        let currentPageConfig = pagesConfig.find(page => page.name === pageName);
        const pageIndex = pagesConfig.indexOf(currentPageConfig);
        const nextButton = htmlGlobals.relativeNavigationButtons.next;
        const prevButton = htmlGlobals.relativeNavigationButtons.prev;

        prevButton.style.disabeled = pageIndex > 0 ? 'true' : 'false';
        prevButton.style.color = pageIndex > 0 ? 'white' : 'gray';
        prevButton.onclick = pageIndex > 0 ? () => displayPage(pagesConfig[pageIndex - 1].name) : null;

        nextButton.style.color = pageIndex + 1 < pageAmount ? 'white' : 'gray';
        nextButton.style.disabeled = pageIndex + 1 < pageAmount ? 'true' : 'false';
        nextButton.onclick = pageIndex + 1 < pageAmount ? () => displayPage(pagesConfig[pageIndex + 1].name) : null;

        for (const pageButton of absoluteNavigationElements) {
            pageButton.style.fontWeight = pageButton.innerHTML === pageName ? 'bold' : 'normal'
        }
    }

    function createAllQuestions() {
        pagesConfig.forEach(page => {
            const pageContainer = document.createElement('fieldset');
            pageContainer.classList.add('page');
            pageContainer.id = page.name;
            page.questions.forEach(question => {
                if (typeof question === 'string') {
                    const label = document.createElement('label');
                    label.innerHTML = question;
                    label.style.borderBottom = '0.1em solid gray';
                    pageContainer.appendChild(label);
                } else {
                    const questionObject = createQuestion(question, page);
                    pageContainer.appendChild(questionObject.getElement());

                    const savedValue = localStorage.getItem(question.id);
                    if (savedValue) questionObject.setValue(savedValue);
                    questionObject.updateColor();
                    questionObjects.push(questionObject); // Add to the page's question list
                }
            });
            htmlGlobals.pagesContainer.appendChild(pageContainer);
        });
    }

    function createQuestion(question, page) {
        const separateLine = question.separateLine || false;

        switch (question.type) {
            case TextQuestion.type:
                return new TextQuestion(question.id, question.title, separateLine, page);
            case NumberQuestion.type:
                return new NumberQuestion(question.id, question.title, separateLine, page);
            case MultipleChoiceQuestion.type:
                return new MultipleChoiceQuestion(question.id, question.title, separateLine, page, question.choices);
            case NumberFromChoicesQuestion.type:
                return new NumberFromChoicesQuestion(question.id, question.title, separateLine, page, question.choices);
        }
    }

    function initializeApp() {
        createAllQuestions();
        renderAbsoluteNavigationButtons(htmlGlobals.absoluteNavContainer);
        displayPage(localStorage.getItem('currentPage') || pagesConfig[0].name);
    }

    function setUpSwipeListeners() {
        document.addEventListener("touchstart", function (event) {
            startX = event.touches[0].clientX;
            startY = event.touches[0].clientY;
        });
        document.addEventListener("touchend", function (event) {
            endX = event.changedTouches[0].clientX;
            endY = event.changedTouches[0].clientY;
            handleSwipe();
        });
    }

    function handleSwipe() {
        let diffX = endX - startX;
        let distanceY = Math.abs(endY - startY);
        if (distanceY > 300) return;

        if (diffX > 175) {
            htmlGlobals.relativeNavigationButtons.prev.click();
        } else if (diffX < -225) {
            htmlGlobals.relativeNavigationButtons.next.click();
        }
    }

    const ALL_TEAMS = [1690, 3339, 5951, 2231, 1574, 1577, 5614, 3075, 5990, 5715, 6740, 1937, 5987, 1657, 4590,
        5654, 7039, 2630, 9739, 2096, 3065, 1942, 6104, 7845, 3316, 5554, 6738, 4320, 9738, 7067, 5928, 3835, 4338,
        3211, 5635, 1576, 9740, 6168, 4416, 3083, 2679, 7112, 8223, 5135, 7177, 4744, 5291, 4586, 2230, 6230, 2212,
        3388, 9304, 8175, 1580, 9303, 1943, 6741, 4319, 1954, 4661].sort();

    const json = {
        "Pages": [
            {
                "name": "Pre",
                "questions": [
                    "General Info",
                    {"id": "scouter_name", "title": "Scouter name", "type": TextQuestion.type},
                    {"id": "game_type", "title": "Game Type", "choices": ["Training", "Qualifications", "Playoffs"], "type": MultipleChoiceQuestion.type},
                    {"id": "game_number", "title": "Game Number", "separateLine": true, "type": NumberQuestion.type}, "Team Info",
                    {"id": "team_number", "title": "Team Number", "choices": ALL_TEAMS, "separateLine": true, "type": NumberFromChoicesQuestion.type},
                    {"id": "alliance", "title": "Alliance", "choices": ["Red", "Blue"], "separateLine": true, "type": MultipleChoiceQuestion.type}
                ]
            },
            {
                "name": "Auto",
                "questions": [
                    {"id": "left_starting_line", "title": "Left starting line", "choices": ["Yes", "No"], "type": MultipleChoiceQuestion.type},
                    "Enter the Amount of Corals Scored:",
                    {"id": "auto_coral_l4", "title": "L4", "type": NumberQuestion.type},
                    {"id": "auto_coral_l3", "title": "L3", "type": NumberQuestion.type},
                    {"id": "auto_coral_l2", "title": "L2", "type": NumberQuestion.type},
                    {"id": "auto_coral_l1", "title": "L1", "type": NumberQuestion.type},
                    "Enter the Amount of Algae removed:",
                    {"id": "auto_low_algae", "title": "Low", "type": NumberQuestion.type},
                    {"id": "auto_high_algae", "title": "High", "type": NumberQuestion.type},
                    "Algae:",
                    {"id": "auto_robot_algae_throws", "title": "Robot Throws to Net", "separateLine": true, "type": NumberQuestion.type},
                    {"id": "auto_algae_inserts", "title": "Algae Processor Inserts", "separateLine": true, "type": NumberQuestion.type},
                    "Human Player:",
                    {"id": "auto_human_player_algae_successful_throws", "title": "Successful Net Throws", "separateLine": true, "type": NumberQuestion.type},
                    {"id": "auto_human_player_algae_failed_throws", "title": "Failed Net Throws", "separateLine": true, "type": NumberQuestion.type},
                ]
            },
            {
                "name": "Teleop",
                "questions": [
                    "Enter the Amount of Corals Scored:",
                    {"id": "teleop_coral_l4", "title": "L4", "type": NumberQuestion.type},
                    {"id": "teleop_coral_l3", "title": "L3", "type": NumberQuestion.type},
                    {"id": "teleop_coral_l2", "title": "L2", "type": NumberQuestion.type},
                    {"id": "teleop_coral_l1", "title": "L1", "type": NumberQuestion.type},
                    "Enter the Amount of Algae removed:",
                    {"id": "teleop_low_algae", "title": "Low", "type": NumberQuestion.type},
                    {"id": "teleop_high_algae", "title": "High", "type": NumberQuestion.type},
                    "Algae:",
                    {"id": "teleop_robot_algae_throws", "title": "Robot Throws to Net", "separateLine": true, "type": NumberQuestion.type},
                    {"id": "teleop_algae_inserts", "title": "Algae Processor Inserts", "separateLine": true, "type": NumberQuestion.type},
                    "Human Player:",
                    {"id": "teleop_human_player_algae_successful_throws", "title": "Successful Net Throws", "separateLine": true, "type": NumberQuestion.type},
                    {"id": "teleop_human_player_algae_failed_throws", "title": "Failed Net Throws", "separateLine": true, "type": NumberQuestion.type},
                ]
            },
            {
                "name": "End",
                "questions": [
                    {"id": "attempted_climbing", "title": "Attempted Climbing", "choices": ["Yes", "No"], "type": MultipleChoiceQuestion.type},
                    {"id": "climb_time", "title": "Time Took to climb", "choices": ["0-5", "5-15", "15-20"], "type": MultipleChoiceQuestion.type},
                    {"id": "successfully_climbed", "title": "Successfully Climbed", "choices": ["Yes", "No"], "type": MultipleChoiceQuestion.type},
                    "High - Shallow ; Low - Deep",
                    {"id": "cage_type", "title": "Cage Type", "choices": ["High", "Low", "None"], "type": MultipleChoiceQuestion.type},
                ]
            },
            {
                "name": "Post",
                "questions": [
                    {"id": "played_defence", "title": "Played Defence", "choices": ["Yes", "No"], "type": MultipleChoiceQuestion.type},
                ]
            },
        ]
    };

    const htmlGlobals = {
        pagesContainer: document.getElementById('pages_container'),
        titleLabel: document.getElementById('title'),
        absoluteNavContainer: document.getElementById('absolute_navigation_container'),
        loadingOverlay: document.getElementById("loadingOverlay"),
        relativeNavigationButtons: {
            prev: document.getElementById('prev_button'),
            next: document.getElementById('next_button'),
        }
    };

    let startX, startY, endX, endY;
    const pagesConfig = json.Pages;
    const pageAmount = pagesConfig.length;
    const questionObjects = [];
    const absoluteNavigationElements = []

    initializeApp();
    setUpSwipeListeners();

    // try to save all unsaved answers every 4 minutes
    setInterval(() => {
        try {
            sendAllUnSavedAnswers();
        } catch (error) {
            console.error("Error in sendAllUnSavedAnswers:", error);
        }
    }, 5 * 1000);

</script>
</html>